/**
 * Lógica do Sistema Caminho do Bem
 */

// --- Estado da Aplicação ---
let activeTab = 'início';
let isSidebarOpen = true;
let isAuthenticated = false; // Controlo de acesso inicial
let users = [
  { id: 1, name: 'João Silva', email: 'joao@exemplo.com' },
  { id: 2, name: 'Maria Santos', email: 'maria@exemplo.com' }
];
let editingId = null;

// --- Inicialização ---
function init() {
  if (window.lucide) window.lucide.createIcons();
  render();
}

// --- Gestão de Interface ---

window.toggleSidebar = function() {
  isSidebarOpen = !isSidebarOpen;
  const sidebar = document.getElementById('sidebar');
  
  if (sidebar) {
    if (isSidebarOpen) {
      sidebar.classList.remove('w-20');
      sidebar.classList.add('w-64');
    } else {
      sidebar.classList.remove('w-64');
      sidebar.classList.add('w-20');
    }
  }
  if (window.lucide) window.lucide.createIcons();
};

window.setActiveTab = function(tab) {
  if (!isAuthenticated) return; // Bloqueia navegação sem login
  activeTab = tab;
  
  // Atualizar botões
  document.querySelectorAll('.nav-item').forEach(btn => {
    const btnTab = btn.getAttribute('data-tab');
    if (btnTab === tab) {
      btn.className = 'nav-item nav-item-active';
    } else {
      btn.className = 'nav-item text-slate-500 hover:bg-slate-50';
    }
  });
  
  render();
};

function showNotice(message, type = 'success') {
  const container = document.getElementById('notification-container');
  if (!container) return;

  const toast = document.createElement('div');
  const bgColor = type === 'success' ? 'bg-white border-emerald-100 text-emerald-700' : 'bg-white border-rose-100 text-rose-700';
  const icon = type === 'success' ? 'check-circle' : 'alert-circle';
  
  toast.className = `flex items-center gap-3 px-5 py-3 rounded-2xl text-sm font-semibold shadow-2xl border animate-fade-in ${bgColor} mb-3 transition-all duration-300 pointer-events-auto`;
  toast.innerHTML = `<i data-lucide="${icon}" size="18"></i> <span>${message}</span>`;
  
  container.appendChild(toast);
  if (window.lucide) window.lucide.createIcons();
  
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateX(20px)";
    setTimeout(() => toast.remove(), 400);
  }, 3000);
}

// --- Renderização de Conteúdo ---

function render() {
  const container = document.getElementById('app-content');
  const sidebar = document.getElementById('sidebar');
  if (!container) return;
  
  container.style.opacity = '0';
  
  setTimeout(() => {
    container.innerHTML = '';
    
    // Se não estiver autenticado, forçar ecrã de login e esconder sidebar
    if (!isAuthenticated) {
      if (sidebar) sidebar.style.display = 'none';
      renderLogin(container);
    } else {
      if (sidebar) sidebar.style.display = 'flex';
      switch(activeTab) {
        case 'início': renderDashboard(container); break;
        case 'membros': renderMembros(container); break;
        case 'config': renderConfig(container); break;
        default: renderEmDesenvolvimento(container);
      }
    }
    
    container.style.opacity = '1';
    if (window.lucide) window.lucide.createIcons();
  }, 150);
}

function renderLogin(container) {
  container.innerHTML = `
    <div class="min-h-[80vh] flex items-center justify-center animate-fade-in">
      <div class="bg-white p-10 md:p-12 rounded-[2.5rem] shadow-2xl border border-slate-100 w-full max-w-md text-center">
        <div class="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center text-white mx-auto mb-8 shadow-xl shadow-indigo-100">
          <i data-lucide="lock" size="36"></i>
        </div>
        <h2 class="text-3xl font-black text-slate-900 mb-2 tracking-tight">Entrar no Sistema</h2>
        <p class="text-slate-400 mb-10 font-medium">Aceda ao painel Caminho do Bem.</p>
        
        <form onsubmit="window.handleLogin(event)" class="space-y-5 text-left">
          <div class="space-y-1">
            <label class="text-[10px] font-black uppercase text-slate-400 ml-1">Utilizador</label>
            <div class="relative">
              <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size="18"></i>
              <input type="text" required class="w-full pl-12 pr-4 py-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all font-medium" placeholder="O seu nome de utilizador">
            </div>
          </div>
          
          <div class="space-y-1">
            <label class="text-[10px] font-black uppercase text-slate-400 ml-1">Palavra-passe</label>
            <div class="relative">
              <i data-lucide="key-round" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size="18"></i>
              <input type="password" required class="w-full pl-12 pr-4 py-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all font-medium" placeholder="••••••••">
            </div>
          </div>

          <button type="submit" class="w-full py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl shadow-indigo-100 hover:bg-indigo-700 active:scale-[0.98] transition-all flex items-center justify-center gap-3 mt-4 group">
            Confirmar Acesso 
            <i data-lucide="arrow-right" size="20" class="group-hover:translate-x-1 transition-transform"></i>
          </button>
        </form>
      </div>
    </div>
  `;
}

window.handleLogin = function(e) {
  e.preventDefault();
  showNotice('A autenticar...');
  setTimeout(() => {
    isAuthenticated = true;
    showNotice('Bem-vindo ao sistema!');
    render();
  }, 800);
};

function renderDashboard(container) {
  container.innerHTML = `
    <div class="space-y-8 animate-fade-in">
      <div class="hero-card p-10 md:p-14 rounded-[2.5rem] text-white relative overflow-hidden shadow-2xl shadow-indigo-100">
        <div class="relative z-10">
          <span class="inline-block px-4 py-1.5 bg-white/20 backdrop-blur-md rounded-full text-[10px] font-black uppercase mb-6 tracking-widest">Painel Administrativo</span>
          <h2 class="text-4xl md:text-6xl font-black mb-6 leading-tight tracking-tight">Caminho <br/><span class="italic font-serif opacity-80 underline decoration-white/20">do Bem</span></h2>
          <p class="text-lg text-indigo-50 max-w-md">Bem-vindo. Tem ${users.length} membros registados no sistema.</p>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        ${renderStat(users.length, 'Membros', 'users')}
        ${renderStat('12', 'Atividades', 'calendar')}
        ${renderStat('98%', 'Presença', 'check-square')}
      </div>
    </div>
  `;
}

function renderStat(val, label, icon) {
  return `
    <div class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm">
      <div class="w-12 h-12 bg-slate-50 text-indigo-600 rounded-2xl flex items-center justify-center mb-4">
        <i data-lucide="${icon}"></i>
      </div>
      <p class="text-3xl font-black text-slate-900">${val}</p>
      <p class="text-slate-400 text-xs font-black uppercase tracking-widest mt-1">${label}</p>
    </div>
  `;
}

function renderMembros(container) {
  container.innerHTML = `
    <div class="animate-fade-in space-y-8">
      <div class="flex justify-between items-center">
        <h2 class="text-3xl font-black">Membros</h2>
        <div class="bg-white px-4 py-2 rounded-2xl border border-slate-100 flex items-center gap-2 shadow-sm">
          <i data-lucide="search" size="18" class="text-slate-300"></i>
          <input type="text" oninput="window.handleSearch(this.value)" placeholder="Pesquisar..." class="outline-none text-sm font-medium bg-transparent">
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1">
          <form onsubmit="window.handleSubmit(event)" class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm space-y-4 sticky top-8">
            <h3 class="font-black text-lg mb-4">${editingId ? 'Editar Membro' : 'Novo Registo'}</h3>
            <input id="in-name" type="text" placeholder="Nome" class="w-full p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all border-none font-medium">
            <input id="in-email" type="email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all border-none font-medium">
            <button class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-xl shadow-indigo-50 hover:bg-indigo-700 transition-all">
              ${editingId ? 'Atualizar' : 'Registrar'}
            </button>
            ${editingId ? `<button type="button" onclick="window.cancelEdit()" class="w-full text-slate-400 font-bold text-sm">Cancelar</button>` : ''}
          </form>
        </div>
        <div id="users-list" class="lg:col-span-2 space-y-4"></div>
      </div>
    </div>
  `;
  renderList();
}

// --- Funções de Ação ---

window.handleSubmit = function(e) {
  e.preventDefault();
  const n = document.getElementById('in-name').value;
  const m = document.getElementById('in-email').value;
  if(!n || !m) return showNotice('Preencha os dados!', 'error');

  if(editingId) {
    users = users.map(u => u.id === editingId ? {id: u.id, name: n, email: m} : u);
    editingId = null;
    showNotice('Atualizado!');
  } else {
    users.push({id: Date.now(), name: n, email: m});
    showNotice('Membro adicionado!');
  }
  render();
}

window.deleteUser = function(id) {
  users = users.filter(u => u.id !== id);
  showNotice('Removido!', 'error');
  render();
}

window.editUser = function(id) {
  const u = users.find(x => x.id === id);
  editingId = id;
  render();
  document.getElementById('in-name').value = u.name;
  document.getElementById('in-email').value = u.email;
}

window.cancelEdit = function() {
  editingId = null;
  render();
}

window.handleSearch = function(val) {
  const filtered = users.filter(u => u.name.toLowerCase().includes(val.toLowerCase()));
  renderList(filtered);
}

function renderList(data = users) {
  const list = document.getElementById('users-list');
  if(!list) return;
  
  list.innerHTML = data.map(u => `
    <div class="bg-white p-6 rounded-3xl border border-slate-100 flex items-center justify-between group hover:shadow-lg transition-all">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center font-black">${u.name[0]}</div>
        <div>
          <p class="font-black text-slate-900">${u.name}</p>
          <p class="text-xs text-slate-400 font-medium">${u.email}</p>
        </div>
      </div>
      <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
        <button onclick="editUser(${u.id})" class="p-2 text-slate-400 hover:text-indigo-600"><i data-lucide="edit-3" size="18"></i></button>
        <button onclick="deleteUser(${u.id})" class="p-2 text-slate-400 hover:text-rose-500"><i data-lucide="trash-2" size="18"></i></button>
      </div>
    </div>
  `).join('');
  if (window.lucide) window.lucide.createIcons();
}

function renderConfig(container) {
    container.innerHTML = `
      <div class="flex flex-col items-center justify-center py-20 text-center animate-fade-in">
        <div class="w-20 h-20 bg-indigo-600 rounded-[2rem] flex items-center justify-center text-white mb-8 shadow-2xl">
          <i data-lucide="shield-check" size="32"></i>
        </div>
        <h2 class="text-4xl font-black mb-4">Administração</h2>
        <p class="text-slate-400 mb-8 max-w-xs font-medium">As suas definições estão seguras e configuradas corretamente.</p>
      </div>
    `;
}

function renderEmDesenvolvimento(container) {
  container.innerHTML = `<div class="py-40 text-center text-slate-200 font-black text-6xl italic uppercase tracking-tighter">Em Breve</div>`;
}

document.addEventListener('DOMContentLoaded', init);
